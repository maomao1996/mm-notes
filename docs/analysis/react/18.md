# React 18 çš„æ–°ç‰¹æ€§

> åœ¨ 2022 å¹´ 3 æœˆ 29 æ—¥ï¼Œ`React 18` æ­£å¼ç‰ˆå‘å¸ƒ

## æ–°ç‰¹æ€§

### Render API

ä¸ºäº†æ›´å¥½çš„ç®¡ç† `root` èŠ‚ç‚¹ï¼Œ`React 18` å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ `root API`ï¼Œæ–°çš„ `root API` è¿˜æ”¯æŒ `new concurrent renderer`ï¼ˆå¹¶å‘æ¨¡å¼çš„æ¸²æŸ“ï¼‰ï¼Œ å®ƒå…è®¸ä½ è¿›å…¥ `concurrent mode`ï¼ˆå¹¶å‘æ¨¡å¼ï¼‰

```tsx
/* React 17 */
import React from 'react'
import ReactDOM from 'react-dom'
import App from './App'

const root = document.getElementById('root')!

ReactDOM.render(<App />, root)

/* React 18 */
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App'

const root = document.getElementById('root')!

ReactDOM.createRoot(root).render(<App />)
```

åœ¨å¸è½½ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°† `unmountComponentAtNode` ä¿®æ”¹ä¸º `root.unmount`

```ts
/* React 17 */
ReactDOM.unmountComponentAtNode(root)

/* React 18 */
root.unmount()
```

::: warning
å¦‚æœåœ¨ `React 18` ä¸­ä½¿ç”¨æ—§çš„ `render api`ï¼Œåœ¨é¡¹ç›®å¯åŠ¨åä¼šåœ¨æ§åˆ¶å°ä¸­è¾“å‡ºä¸€ä¸ªè­¦å‘Šï¼š

![react 18 render api warning](./images/react-18/react-18-render-warning.png)

è¿™è¡¨ç¤ºä½ å¯ä»¥å°†é¡¹ç›®ç›´æ¥å‡çº§åˆ° `React 18` ç‰ˆæœ¬ï¼Œè€Œä¸ä¼šç›´æ¥é€ æˆ **`break change`**ã€‚å¦‚æœä½ éœ€è¦ä¿æŒç€ `React 17` ç‰ˆæœ¬çš„ç‰¹æ€§çš„è¯ï¼Œé‚£ä¹ˆä½ å¯ä»¥æ— è§†è¿™ä¸ªæŠ¥é”™ï¼Œå› ä¸ºå®ƒåœ¨æ•´ä¸ª `18` ç‰ˆæœ¬ä¸­éƒ½æ˜¯å…¼å®¹çš„
:::

`React 18` è¿˜ä» `render` æ–¹æ³•ä¸­åˆ é™¤äº†å›è°ƒå‡½æ•°ï¼Œå› ä¸ºåœ¨ä½¿ç”¨ `Suspense` æ—¶ï¼Œå®ƒé€šå¸¸ä¸ä¼šæœ‰é¢„æœŸçš„ç»“æœ

å¦‚æœéœ€è¦åœ¨ `render` æ–¹æ³•ä¸­ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶ä¸­é€šè¿‡ `useEffect` å®ç°ï¼š

```tsx
/* React 17 */
const root = document.getElementById('root')
ReactDOM.render(<App />, root, () => {
  console.log('æ¸²æŸ“å®Œæˆ')
})

/* React 18 */
const AppWithCallback: React.FC = () => {
  useEffect(() => {
    console.log('æ¸²æŸ“å®Œæˆ')
  }, [])

  return <App />
}
const root = document.getElementById('root')
ReactDOM.createRoot(root).render(<AppWithCallback />)
```

å¦‚æœåœ¨é¡¹ç›®ä½¿ç”¨äº† `ssr` æœåŠ¡ç«¯æ¸²æŸ“ï¼Œéœ€è¦æŠŠ `hydration` å‡çº§ä¸º `hydrateRoot`

```tsx
/* React 17 */
import ReactDOM from 'react-dom'
const root = document.getElementById('root')
ReactDOM.hydrate(<App />, root)

/* React 18 */
import ReactDOM from 'react-dom/client'
const root = document.getElementById('root')
ReactDOM.hydrateRoot(root, <App />)
```

å¦‚æœåœ¨é¡¹ç›®ä½¿ç”¨äº† `TypeScript`ï¼Œè¿˜éœ€è¦æ›´æ–° `TypeScript` ç±»å‹å®šä¹‰

åœ¨å®šä¹‰ `props` ç±»å‹æ—¶ï¼Œå¦‚æœéœ€è¦è·å–å­ç»„ä»¶ `children`ï¼Œé‚£ä¹ˆä½ éœ€è¦æ˜¾å¼çš„å®šä¹‰å®ƒï¼Œä¾‹å¦‚è¿™æ ·ï¼š

```tsx
/* React 17 */
interface MyButtonProps {
  color: string
}

const MyButton: React.FC<MyButtonProps> = ({ children }) => {
  // åœ¨ React 17 çš„ FC ä¸­ï¼Œé»˜è®¤æºå¸¦äº† children å±æ€§
  return <div>{children}</div>
}

export default MyButton

/* React 18 */
interface MyButtonProps {
  color: string
  children?: React.ReactNode
}

const MyButton: React.FC<MyButtonProps> = ({ children }) => {
  // åœ¨ React 18 çš„ FC ä¸­ï¼Œä¸å­˜åœ¨ children å±æ€§ï¼Œéœ€è¦æ‰‹åŠ¨ç”³æ˜
  return <div>{children}</div>
}

export default MyButton
```

### `Automatic Batching` è‡ªåŠ¨æ‰¹å¤„ç†

`React 18` é€šè¿‡åœ¨é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œæ‰¹å¤„ç†æ¥å®ç°äº†å¼€ç®±å³ç”¨çš„æ€§èƒ½æ”¹è¿›

::: tip
æ‰¹å¤„ç†æ˜¯æŒ‡ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œåœ¨æ•°æ®å±‚å°†å¤šä¸ªçŠ¶æ€æ›´æ–°æ‰¹é‡å¤„ç†ï¼Œåˆå¹¶æˆä¸€æ¬¡æ›´æ–°ï¼ˆåœ¨è§†å›¾å±‚ï¼Œå°†å¤šä¸ªæ¸²æŸ“åˆå¹¶æˆä¸€æ¬¡æ¸²æŸ“ï¼‰
:::

#### `React 18` ä¹‹å‰

åœ¨ `React 18` ä¹‹å‰ï¼Œæˆ‘ä»¬åªåœ¨ `React` äº‹ä»¶å¤„ç†å‡½æ•° ä¸­è¿›è¡Œæ‰¹å¤„ç†æ›´æ–°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨ `promise`ã€`setTimeout`ã€`åŸç”Ÿäº‹ä»¶å¤„ç†å‡½æ•°`ä¸­ã€æˆ–`ä»»ä½•å…¶å®ƒäº‹ä»¶å†…`çš„æ›´æ–°éƒ½ä¸ä¼šè¿›è¡Œæ‰¹å¤„ç†

##### `React` äº‹ä»¶å¤„ç†å‡½æ•°

```tsx
import React, { useState } from 'react'

// React 18 ä¹‹å‰
const App: React.FC = () => {
  console.log('Appç»„ä»¶æ¸²æŸ“äº†ï¼')
  const [count1, setCount1] = useState(0)
  const [count2, setCount2] = useState(0)
  return (
    <button
      onClick={() => {
        setCount1((count) => count + 1)
        setCount2((count) => count + 1)
        // åœ¨Reactäº‹ä»¶ä¸­è¢«æ‰¹å¤„ç†
      }}
    >
      {`count1 is ${count1}, count2 is ${count2}`}
    </button>
  )
}

export default App
```

![åŠ¨ç”»](./images/react-18/gif-1.gif)

> æ¸²æŸ“æ¬¡æ•°å’Œæ›´æ–°æ¬¡æ•°æ˜¯ä¸€æ ·çš„ï¼Œå³ä½¿æˆ‘ä»¬æ›´æ–°äº†ä¸¤ä¸ªçŠ¶æ€ï¼Œæ¯æ¬¡æ›´æ–°ç»„ä»¶ä¹Ÿåªæ¸²æŸ“ä¸€æ¬¡

##### `setTimeout`

```tsx
import React, { useState } from 'react'

// React 18 ä¹‹å‰
const App: React.FC = () => {
  console.log('Appç»„ä»¶æ¸²æŸ“äº†ï¼')
  const [count1, setCount1] = useState(0)
  const [count2, setCount2] = useState(0)
  return (
    <div
      onClick={() => {
        setTimeout(() => {
          setCount1((count) => count + 1)
          setCount2((count) => count + 1)
        })
        // åœ¨ setTimeout ä¸­ä¸ä¼šè¿›è¡Œæ‰¹å¤„ç†
      }}
    >
      <div>count1ï¼š {count1}</div>
      <div>count2ï¼š {count2}</div>
    </div>
  )
}

export default App
```

![åŠ¨ç”»](./images/react-18/gif-2.gif)

> æ¯æ¬¡ç‚¹å‡»æ›´æ–°ä¸¤ä¸ªçŠ¶æ€ï¼Œç»„ä»¶éƒ½ä¼šæ¸²æŸ“ä¸¤æ¬¡ä¸ä¼šè¿›è¡Œæ‰¹é‡æ›´æ–°

##### åŸç”Ÿäº‹ä»¶

```ts
import React, { useEffect, useState } from 'react'

// React 18 ä¹‹å‰
const App: React.FC = () => {
  console.log('Appç»„ä»¶æ¸²æŸ“äº†ï¼')
  const [count1, setCount1] = useState(0)
  const [count2, setCount2] = useState(0)
  useEffect(() => {
    document.body.addEventListener('click', () => {
      setCount1((count) => count + 1)
      setCount2((count) => count + 1)
    })
    // åœ¨åŸç”Ÿjsäº‹ä»¶ä¸­ä¸ä¼šè¿›è¡Œæ‰¹å¤„ç†
  }, [])
  return (
    <>
      <div>count1ï¼š {count1}</div>
      <div>count2ï¼š {count2}</div>
    </>
  )
}

export default App
```

![åŠ¨ç”»](./images/react-18/gif-3.gif)

> æ¯æ¬¡ç‚¹å‡»ä¼šæ›´æ–°ä¸¤ä¸ªçŠ¶æ€ï¼Œç»„ä»¶éƒ½ä¼šæ¸²æŸ“ä¸¤æ¬¡ä¸ä¼šè¿›è¡Œæ‰¹é‡æ›´æ–°

#### `React 18` å‘å¸ƒå

åœ¨ `React 18` å‘å¸ƒåä¸Šé¢çš„ä¸‰ä¸ªä¾‹å­åªä¼š `render` ä¸€æ¬¡ï¼Œå› ä¸ºæ‰€æœ‰çš„æ›´æ–°éƒ½å°†è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆæé«˜äº†åº”ç”¨çš„æ•´ä½“æ€§èƒ½ï¼‰

**ä¸è¿‡ä»¥ä¸‹ä¾‹å­ä¼šåœ¨ React 18 ä¸­æ‰§è¡Œä¸¤æ¬¡ render**ï¼š

```tsx
import React, { useState } from 'react'

// React 18
const App: React.FC = () => {
  console.log('Appç»„ä»¶æ¸²æŸ“äº†ï¼')
  const [count1, setCount1] = useState(0)
  const [count2, setCount2] = useState(0)
  return (
    <div
      onClick={async () => {
        await setCount1((count) => count + 1)
        setCount2((count) => count + 1)
      }}
    >
      <div>count1ï¼š {count1}</div>
      <div>count2ï¼š {count2}</div>
    </div>
  )
}

export default App
```

### `flushSync`

æ‰¹å¤„ç†æ˜¯ä¸€ä¸ª**ç ´åæ€§æ”¹åŠ¨**ï¼Œå¦‚æœæƒ³é€€å‡ºæ‰¹é‡æ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨ `flushSync`

```tsx
import React, { useState } from 'react'
import { flushSync } from 'react-dom'

const App: React.FC = () => {
  const [count1, setCount1] = useState(0)
  const [count2, setCount2] = useState(0)
  return (
    <div
      onClick={() => {
        flushSync(() => {
          setCount1((count) => count + 1)
        })
        // ç¬¬ä¸€æ¬¡æ›´æ–°
        flushSync(() => {
          setCount2((count) => count + 1)
        })
        // ç¬¬äºŒæ¬¡æ›´æ–°
      }}
    >
      <div>count1ï¼š {count1}</div>
      <div>count2ï¼š {count2}</div>
    </div>
  )
}

export default App
```

::: warning
`flushSync` å‡½æ•°å†…éƒ¨çš„å¤šä¸ª `setState` ä»ç„¶ä¸ºæ‰¹é‡æ›´æ–°ï¼Œè¿™æ ·å¯ä»¥ç²¾å‡†æ§åˆ¶å“ªäº›ä¸éœ€è¦çš„æ‰¹é‡æ›´æ–°

æœ‰å…³**æ‰¹å¤„ç†**å’Œ `flushSync` çš„æ›´å¤šä¿¡æ¯ï¼Œä½ å¯ä»¥å‚é˜… `React` å®˜æ–¹çš„ [Automatic batching deep diveï¼ˆæ‰¹å¤„ç†æ·±åº¦åˆ†æï¼‰](https://github.com/reactwg/react-18/discussions/21)
:::

### å¸è½½ç»„ä»¶æ—¶çš„æ›´æ–°çŠ¶æ€è­¦å‘Š

åœ¨å¼€å‘æ—¶å¶å°”ä¼šé‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

![react 18 render api warning](./images/react-18/react-unmounted-error.png)

> è¿™ä¸ªé”™è¯¯è¡¨ç¤ºï¼š**æ— æ³•å¯¹æœªæŒ‚è½½ï¼ˆå·²å¸è½½ï¼‰çš„ç»„ä»¶æ‰§è¡ŒçŠ¶æ€æ›´æ–°ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— æ•ˆæ“ä½œï¼Œå¹¶ä¸”è¡¨æ˜æˆ‘ä»¬çš„ä»£ç ä¸­å­˜åœ¨å†…å­˜æ³„æ¼**

å®é™…ä¸Šï¼Œè¿™ä¸ªé”™è¯¯å¹¶ä¸å¤šè§ï¼Œåœ¨ä»¥å¾€çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªè­¦å‘Šè¢«å¹¿æ³›è¯¯è§£ï¼Œå¹¶ä¸”æœ‰äº›è¯¯å¯¼ã€‚è¿™ä¸ªé”™è¯¯çš„åˆè¡·æ˜¯é’ˆå¯¹ä¸€äº›ç‰¹æ®Šåœºæ™¯ï¼Œè­¬å¦‚ ä½ åœ¨ `useEffect` é‡Œé¢è®¾ç½®äº†å®šæ—¶å™¨ï¼Œæˆ–è€…è®¢é˜…äº†æŸä¸ªäº‹ä»¶ï¼Œä»è€Œåœ¨ç»„ä»¶å†…éƒ¨äº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œè€Œä¸”å¿˜è®° `return` ä¸€ä¸ªå‡½æ•°æ¸…é™¤å‰¯ä½œç”¨ï¼Œåˆ™ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ç­‰ä¹‹ç±»çš„åœºæ™¯

ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ›´å¤šçš„åœºæ™¯æ˜¯æˆ‘ä»¬åœ¨ `useEffect` é‡Œé¢å‘é€äº†ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œåœ¨å¼‚æ­¥å‡½æ•°è¿˜æ²¡æœ‰è¢« `resolve` æˆ–è€… `reject` æ—¶ï¼Œæˆ‘ä»¬å°±å¸è½½äº†ç»„ä»¶ã€‚åœ¨è¿™ç§åœºæ™¯ä¸­è­¦å‘ŠåŒæ ·ä¼šè§¦å‘ã€‚ä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç»„ä»¶å†…éƒ¨å¹¶æ²¡æœ‰å†…å­˜æ³„æ¼ï¼Œå› ä¸ºè¿™ä¸ªå¼‚æ­¥å‡½æ•°å·²ç»è¢«åƒåœ¾å›æ”¶äº†ï¼Œæ­¤æ—¶è­¦å‘Šå°±å­˜åœ¨è¯¯å¯¼æ€§ã€‚å…³äºè¿™ç‚¹ `React` å®˜æ–¹ä¹Ÿæœ‰è§£é‡Šï¼š

::: info Other Notable Changes
No warning about setState on unmounted components: Previously, React warned about memory leaks when you call setState on an unmounted component. This warning was added for subscriptions, but people primarily run into it in scenarios where setting state is fine, and workarounds make the code worse. Weâ€™ve removed this warning.

[Other Notable Changes](https://react.docschina.org/blog/2022/03/08/react-18-upgrade-guide#other-notable-changes)
:::

æ‰€ä»¥åœ¨ `React 18` ä¸­ï¼Œå®˜æ–¹åˆ é™¤äº†è¿™ä¸ªæŠ¥é”™ï¼ˆæœ‰å…³è¿™ä¸ªæŠ¥é”™çš„æ›´å¤šä¿¡æ¯ï¼Œä½ å¯ä»¥[å‚é˜… React å®˜æ–¹çš„è¯´æ˜](https://github.com/reactwg/react-18/discussions/82)ï¼‰

### `React` ç»„ä»¶çš„è¿”å›å€¼

- åœ¨ `React 17` ä¸­ï¼Œå¦‚æœä½ éœ€è¦è¿”å›ä¸€ä¸ª`ç©ºç»„ä»¶`ï¼Œ`React` åªå…è®¸è¿”å›`null`ã€‚å¦‚æœä½ æ˜¾å¼çš„è¿”å›äº† `undefined`ï¼Œæ§åˆ¶å°åˆ™ä¼šåœ¨è¿è¡Œæ—¶æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚
- åœ¨ `React 18` ä¸­ï¼Œä¸å†æ£€æŸ¥å› è¿”å› `undefined` è€Œå¯¼è‡´å´©æºƒï¼›å³èƒ½è¿”å› `null`ï¼Œä¹Ÿå¯ä»¥è¿”å› `undefined`ï¼ˆä½†æ˜¯ `React 18` çš„ `d.ts` æ–‡ä»¶è¿˜æ˜¯ä¼šæ£€æŸ¥ï¼Œåªå…è®¸è¿”å› `null`ï¼Œä½ å¯ä»¥å¿½ç•¥è¿™ä¸ªç±»å‹é”™è¯¯ï¼‰

### `Strict Mode`

ä¸å†æŠ‘åˆ¶æ§åˆ¶å°æ—¥å¿—ï¼š

å½“ä½ ä½¿ç”¨`ä¸¥æ ¼æ¨¡å¼`æ—¶ï¼Œ`React` ä¼šå¯¹æ¯ä¸ªç»„ä»¶è¿›è¡Œ`ä¸¤æ¬¡æ¸²æŸ“`ï¼Œä»¥ä¾¿ä½ è§‚å¯Ÿä¸€äº›æ„æƒ³ä¸åˆ°çš„ç»“æœã€‚åœ¨ `React 17` ä¸­ï¼Œå–æ¶ˆäº†`å…¶ä¸­ä¸€æ¬¡æ¸²æŸ“`çš„æ§åˆ¶å°æ—¥å¿—ï¼Œä»¥ä¾¿è®©æ—¥å¿—æ›´å®¹æ˜“é˜…è¯»ã€‚

ä¸ºäº†è§£å†³ç¤¾åŒºå¯¹è¿™ä¸ªé—®é¢˜çš„å›°æƒ‘ï¼Œåœ¨ `React 18` ä¸­ï¼Œå®˜æ–¹å–æ¶ˆäº†è¿™ä¸ªé™åˆ¶ï¼›å¦‚æœä½ å®‰è£…äº†`React DevTools`ï¼Œç¬¬äºŒæ¬¡æ¸²æŸ“çš„æ—¥å¿—ä¿¡æ¯å°†æ˜¾ç¤ºä¸ºç°è‰²ï¼Œä»¥æŸ”å’Œçš„æ–¹å¼æ˜¾å¼åœ¨æ§åˆ¶å°ã€‚

[å…³äºç»„ä»¶è¿”å›å€¼çš„å®˜æ–¹è§£é‡Š](https://github.com/reactwg/react-18/discussions/96)

### `Suspense` ä¸å†éœ€è¦ `fallback` æ¥æ•è·

`React 18` åœ¨æ¸²æŸ“ `Suspense` ç»„ä»¶æ—¶ï¼Œå¯¹ `ç©ºçš„ fallback` å±æ€§çš„å¤„ç†åšäº†æ”¹å˜ï¼šä¸å†è·³è¿‡ `ç¼ºå¤±å€¼` æˆ– `å€¼ä¸º null` çš„ `fallback` çš„ `Suspense` è¾¹ç•Œã€‚ç›¸åï¼Œä¼šæ•è·è¾¹ç•Œå¹¶ä¸”å‘å¤–å±‚æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾ä¸åˆ°å°†ä¼šæŠŠ `fallback` å‘ˆç°ä¸º `null`

**`React 17`**ï¼š

å¦‚æœ `Suspense` ç»„ä»¶æ²¡æœ‰æä¾› `fallback` å±æ€§ï¼Œ`React` å°±ä¼šæ‚„æ‚„è·³è¿‡å®ƒï¼Œç»§ç»­å‘ä¸Šæœç´¢ä¸‹ä¸€ä¸ªè¾¹ç•Œï¼š

```tsx
const App: React.FC = () => {
  return (
    <Suspense fallback={<Loading />}>  // <--- è¿™ä¸ªè¾¹ç•Œè¢«ä½¿ç”¨ï¼Œæ˜¾ç¤º Loading ç»„ä»¶
      <Suspense>                       // <--- è¿™ä¸ªè¾¹ç•Œè¢«è·³è¿‡ï¼Œæ²¡æœ‰ fallback å±æ€§
        <Page />
      </Suspense>
    </Suspense>
  );
};

export default App;
```

`React` å·¥ä½œç»„å‘ç°è¿™å¯èƒ½ä¼šå¯¼è‡´æ··ä¹±ã€éš¾ä»¥è°ƒè¯•çš„æƒ…å†µå‘ç”Ÿã€‚ä¾‹å¦‚ï¼Œä½ æ­£åœ¨ `debug` ä¸€ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”åœ¨æ²¡æœ‰ `fallback` å±æ€§çš„ `Suspense` ç»„ä»¶ä¸­æŠ›å‡ºä¸€ä¸ªè¾¹ç•Œæ¥æµ‹è¯•ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒå¯èƒ½ä¼šå¸¦æ¥ä¸€äº›æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œå¹¶ä¸” `ä¸ä¼šè­¦å‘Š` æç¤º `æ²¡æœ‰fallback` å±æ€§

**`React 18`**ï¼š

`React 18` å°†ä½¿ç”¨å½“å‰ç»„ä»¶çš„ `Suspense` ä½œä¸ºè¾¹ç•Œï¼Œå³ä½¿å½“å‰ç»„ä»¶çš„ `Suspense` çš„å€¼ä¸º `null` æˆ– `undefined`

```tsx
const App: React.FC = () => {
  return (
    <Suspense fallback={<Loading />}>  // <--- ä¸ä½¿ç”¨
      <Suspense>                       // <--- è¿™ä¸ªè¾¹ç•Œè¢«ä½¿ç”¨ï¼Œå°† fallback æ¸²æŸ“ä¸º null
        <Page />
      </Suspense>
    </Suspense>
  );
};

export default App;
```

è¿™ä¸ªæ›´æ–°æ„å‘³ç€æˆ‘ä»¬`ä¸å†è·¨è¶Šè¾¹ç•Œç»„ä»¶`ã€‚ç›¸åæˆ‘ä»¬å°†åœ¨è¾¹ç•Œå¤„æ•è·å¹¶å‘ˆç° `fallback`ï¼Œå°±åƒä½ æä¾›äº†ä¸€ä¸ªè¿”å›å€¼ä¸º `null` çš„ç»„ä»¶ä¸€æ ·ã€‚è¿™æ„å‘³ç€è¢«æŒ‚èµ·çš„ `Suspense` ç»„ä»¶å°†æŒ‰ç…§é¢„æœŸç»“æœå»æ‰§è¡Œï¼Œå¦‚æœå¿˜è®°æä¾› `fallback` å±æ€§ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜

[å…³äº Suspense çš„å®˜æ–¹è§£é‡Š](https://github.com/reactwg/react-18/discussions/72)

## æ–°çš„ `API`

### `useId`

```tsx
const id = useId()
```

æ”¯æŒåŒä¸€ä¸ªç»„ä»¶åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç”Ÿæˆç›¸åŒçš„å”¯ä¸€ `ID`ï¼Œé¿å… `hydration` çš„ä¸å…¼å®¹ï¼Œè¿™è§£å†³äº†åœ¨ `React 18` ä¹‹å‰çš„ç‰ˆæœ¬ä¸­å·²ç»å­˜åœ¨çš„é—®é¢˜ã€‚å› ä¸ºæˆ‘ä»¬çš„æœåŠ¡å™¨æ¸²æŸ“æ—¶æä¾›çš„ `HTML` æ˜¯`æ— åºçš„`ï¼Œ`useId` çš„åŸç†å°±æ˜¯æ¯ä¸ª `id` ä»£è¡¨è¯¥ç»„ä»¶åœ¨ç»„ä»¶æ ‘ä¸­çš„å±‚çº§ç»“æ„

å…³äº `useId` çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [useId post in the working group](https://github.com/reactwg/react-18/discussions/111)

### `useSyncExternalStore`

`useSyncExternalStore` æ˜¯ä¸€ä¸ªæ–°çš„ `api`ï¼Œå…¶ç»å†äº†ä¸€æ¬¡ä¿®æ”¹ï¼Œç”± `useMutableSource` ä¿®æ”¹è€Œæ¥ï¼Œä¸»è¦ç”¨æ¥è§£å†³å¤–éƒ¨æ•°æ®æ’•è£‚é—®é¢˜

`useSyncExternalStore` ä¸€èˆ¬æ˜¯ä¸‰æ–¹çŠ¶æ€ç®¡ç†åº“ä½¿ç”¨ï¼Œåœ¨æ—¥å¸¸ä¸šåŠ¡ä¸­ä¸éœ€è¦å…³æ³¨ã€‚å› ä¸º `React` è‡ªèº«çš„ `useState` å·²ç»åŸç”Ÿçš„è§£å†³çš„å¹¶å‘ç‰¹æ€§ä¸‹çš„ `tearï¼ˆæ’•è£‚ï¼‰`é—®é¢˜ã€‚`useSyncExternalStore` ä¸»è¦å¯¹äºæ¡†æ¶å¼€å‘è€…ï¼Œæ¯”å¦‚ `redux`ï¼Œå®ƒåœ¨æ§åˆ¶çŠ¶æ€æ—¶å¯èƒ½å¹¶éç›´æ¥ä½¿ç”¨çš„ `React` çš„ `state`ï¼Œè€Œæ˜¯è‡ªå·±åœ¨å¤–éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª `store` å¯¹è±¡ï¼Œç”¨`å‘å¸ƒè®¢é˜…æ¨¡å¼`å®ç°äº†æ•°æ®æ›´æ–°ï¼Œè„±ç¦»äº† `React` çš„ç®¡ç†ï¼Œä¹Ÿå°±æ— æ³•ä¾é  `React` è‡ªåŠ¨è§£å†³æ’•è£‚é—®é¢˜ã€‚å› æ­¤ `React` å¯¹å¤–æä¾›äº†è¿™æ ·ä¸€ä¸ª `API`ã€‚

ç›®å‰ `React-Redux 8.0` å·²ç»åŸºäº `useSyncExternalStore` å®ç°ã€‚

å…³äº `useSyncExternalStore` çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [useSyncExternalStore overview post](https://github.com/reactwg/react-18/discussions/70) å’Œ [useSyncExternalStore API details](https://github.com/reactwg/react-18/discussions/86)

### `useInsertionEffect`

```tsx
const useCSS = (rule) => {
  useInsertionEffect(() => {
    if (!isInserted.has(rule)) {
      isInserted.add(rule)
      document.head.appendChild(getStyleForRule(rule))
    }
  })
  return rule
}

const App: React.FC = () => {
  const className = useCSS(rule)
  return <div className={className} />
}

export default App
```

è¿™ä¸ª `Hooks` åªå»ºè®® `css-in-js` åº“æ¥ä½¿ç”¨ã€‚ è¿™ä¸ª `Hooks` æ‰§è¡Œæ—¶æœºåœ¨ `DOM` ç”Ÿæˆä¹‹åï¼Œ`useLayoutEffect` ä¹‹å‰ï¼Œå®ƒçš„å·¥ä½œåŸç†å¤§è‡´å’Œ `useLayoutEffect` ç›¸åŒï¼Œåªæ˜¯æ­¤æ—¶æ— æ³•è®¿é—® `DOM` èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä¸€èˆ¬ç”¨äºæå‰æ³¨å…¥ `<style>` è„šæœ¬

å…³äº `useInsertionEffect` çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Library Upgrade Guide for `<style>`](https://github.com/reactwg/react-18/discussions/110)

## `Concurrent Mode` å¹¶å‘æ¨¡å¼

`Concurrent Mode`ï¼ˆä»¥ä¸‹ç®€ç§° `CM`ï¼‰ç¿»è¯‘å«å¹¶å‘æ¨¡å¼ï¼Œè¿™ä¸ªæ¦‚å¿µæˆ‘ä»¬æˆ–è®¸å·²ç»å¬è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œå®é™…ä¸Šåœ¨å»å¹´è¿™ä¸ªæ¦‚å¿µå·²ç»å¾ˆæˆç†Ÿäº†ï¼Œåœ¨ `React 17` ä¸­å°±å¯ä»¥é€šè¿‡ä¸€äº›`è¯•éªŒæ€§`çš„ `api` æ¥å¼€å¯ `CM`

`CM` æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼Œè€Œæ˜¯ä¸€ä¸ªåº•å±‚è®¾è®¡ï¼Œå®ƒå¯ä»¥å¸®åŠ©åº”ç”¨ä¿æŒå“åº”ï¼Œå¹¶æ ¹æ®ç”¨æˆ·çš„è®¾å¤‡æ€§èƒ½å’Œç½‘é€Ÿè¿›è¡Œé€‚å½“çš„è°ƒæ•´ï¼Œè¯¥æ¨¡å¼é€šè¿‡ä½¿æ¸²æŸ“å¯ä¸­æ–­æ¥ä¿®å¤`é˜»å¡æ¸²æŸ“`é™åˆ¶ã€‚åœ¨å¹¶å‘æ¨¡å¼ä¸­ `React` å¯ä»¥åŒæ—¶æ›´æ–°å¤šä¸ªçŠ¶æ€

::: tip
`React 17` å’Œ `React 18` çš„åŒºåˆ«å°±æ˜¯ï¼š**ä»åŒæ­¥ä¸å¯ä¸­æ–­æ›´æ–°å˜æˆäº†å¼‚æ­¥å¯ä¸­æ–­æ›´æ–°**
:::

### å¼€å¯å¹¶å‘æ¨¡å¼å°±æ˜¯å¼€å¯å¹¶å‘æ›´æ–°å—ï¼Ÿ

> åœ¨ `React 18` ä¸­ï¼Œæä¾›äº†æ–°çš„ `root api`ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ `render` å‡çº§æˆ `createRoot(root).render(<App />)` å°±å¯ä»¥å¼€å¯å¹¶å‘æ¨¡å¼

åœ¨ `React 17` çš„ä¸€äº›å®éªŒæ€§åŠŸèƒ½é‡Œé¢ï¼Œå¼€å¯`å¹¶å‘æ¨¡å¼`å°±æ˜¯å¼€å¯`å¹¶å‘æ›´æ–°`ï¼Œä½†åœ¨ `React 18` æ­£å¼ç‰ˆå‘å¸ƒåï¼Œç”±äºå®˜æ–¹ç­–ç•¥è°ƒæ•´ `React` ä¸å†ä¾èµ–å¹¶å‘æ¨¡å¼å¼€å¯å¹¶å‘æ›´æ–°ï¼Œå³å¼€å¯`å¹¶å‘æ¨¡å¼`å¹¶ä¸ä¸€å®šå¼€å¯äº†`å¹¶å‘æ›´æ–°`

::: tip
**åœ¨ `18` ä¸­ä¸å†æœ‰å¤šç§æ¨¡å¼ï¼Œè€Œæ˜¯ä»¥`æ˜¯å¦ä½¿ç”¨å¹¶å‘ç‰¹æ€§`ä½œä¸º`æ˜¯å¦å¼€å¯å¹¶å‘æ›´æ–°`çš„ä¾æ®**
:::

ä»æœ€è€çš„ç‰ˆæœ¬åˆ°å½“å‰çš„ `v18`ï¼Œå¸‚é¢ä¸Šæœ‰å¤šå°‘ä¸ªç‰ˆæœ¬çš„`React`ï¼Ÿ

å¯ä»¥ä»æ¶æ„è§’åº¦æ¥æ¦‚æ‹¬ä¸‹ï¼Œå½“å‰ä¸€å…±æœ‰ä¸¤ç§æ¶æ„ï¼š

- é‡‡ç”¨ä¸å¯ä¸­æ–­çš„`é€’å½’`æ–¹å¼æ›´æ–°çš„`Stack Reconciler`ï¼ˆè€æ¶æ„ï¼‰
- é‡‡ç”¨å¯ä¸­æ–­çš„`éå†`æ–¹å¼æ›´æ–°çš„`Fiber Reconciler`ï¼ˆæ–°æ¶æ„ï¼‰

æ–°æ¶æ„å¯ä»¥é€‰æ‹©æ˜¯å¦å¼€å¯`å¹¶å‘æ›´æ–°`ï¼Œæ‰€ä»¥å½“å‰å¸‚é¢ä¸Šæ‰€æœ‰ `React` ç‰ˆæœ¬æœ‰å››ç§æƒ…å†µï¼š

1. è€æ¶æ„ï¼ˆv15 åŠä¹‹å‰ç‰ˆæœ¬ï¼‰
2. æ–°æ¶æ„ï¼Œæœªå¼€å¯å¹¶å‘æ›´æ–°ï¼Œä¸æƒ…å†µ 1 è¡Œä¸ºä¸€è‡´ï¼ˆv16ã€v17 é»˜è®¤å±äºè¿™ç§æƒ…å†µï¼‰
3. æ–°æ¶æ„ï¼Œæœªå¼€å¯å¹¶å‘æ›´æ–°ï¼Œä½†å¯ç”¨äº†å¹¶å‘æ¨¡å¼å’Œä¸€äº›æ–°åŠŸèƒ½ï¼ˆæ¯”å¦‚ `Automatic Batching`ï¼Œv18 é»˜è®¤å±äºè¿™ç§æƒ…å†µï¼‰
4. æ–°æ¶æ„ï¼Œå¼€å¯å¹¶å‘æ¨¡å¼ï¼Œå¼€å¯å¹¶å‘æ›´æ–°

`å¹¶å‘ç‰¹æ€§`æŒ‡å¼€å¯`å¹¶å‘æ¨¡å¼`åæ‰èƒ½ä½¿ç”¨çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ï¼š

- `useDeferredValue`
- `useTransition`

![å…³ç³»å›¾](./images/react-18/diagram.png)

### å¹¶å‘ç‰¹æ€§

<br />

#### `startTransition`

åœ¨ `React 18` ä¸­è¿è¡Œå¦‚ä¸‹ä»£ç ï¼š

```tsx
import React, { useState, useEffect, useTransition } from 'react'

const App: React.FC = () => {
  const [list, setList] = useState<any[]>([])
  const [isPending, startTransition] = useTransition()
  useEffect(() => {
    // ä½¿ç”¨äº†å¹¶å‘ç‰¹æ€§ï¼Œå¼€å¯å¹¶å‘æ›´æ–°
    startTransition(() => {
      setList(new Array(10000).fill(null))
    })
  }, [])
  return (
    <>
      {list.map((_, i) => (
        <div key={i}>{i}</div>
      ))}
    </>
  )
}

export default App
```

ç”±äº `setList` åœ¨ `startTransition` çš„å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œï¼ˆä½¿ç”¨`å¹¶å‘ç‰¹æ€§`ï¼‰ï¼Œæ‰€ä»¥ `setList` ä¼šè§¦å‘`å¹¶å‘æ›´æ–°`

`startTransition` ä¸»è¦ä¸ºäº†èƒ½åœ¨å¤§é‡çš„ä»»åŠ¡ä¸‹ä¹Ÿèƒ½ä¿æŒ `UI` å“åº”ã€‚è¿™ä¸ª `API` å¯ä»¥é€šè¿‡å°†ç‰¹å®šæ›´æ–°æ ‡è®°ä¸º`â€œè¿‡æ¸¡â€`æ¥æ˜¾è‘—æ”¹å–„ç”¨æˆ·äº¤äº’ï¼Œå³è¢« `startTransition` å›è°ƒåŒ…è£¹çš„ `setState` è§¦å‘çš„æ¸²æŸ“è¢«æ ‡è®°ä¸ºä¸ç´§æ€¥æ¸²æŸ“ï¼Œè¿™äº›æ¸²æŸ“å¯èƒ½è¢«å…¶ä»–`ç´§æ€¥æ¸²æŸ“`æ‰€æŠ¢å 

- å…³äº `startTransition` çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Patterns for startTransition](https://github.com/reactwg/react-18/discussions/100)

#### `useDeferredValue`

`useDeferredValue` ä¼šè¿”å›ä¸€ä¸ªå»¶è¿Ÿå“åº”çš„å€¼ï¼Œå³è®©ä¸€ä¸ª `state` å»¶è¿Ÿç”Ÿæ•ˆï¼ˆåªæœ‰å½“å‰æ²¡æœ‰ç´§æ€¥æ›´æ–°æ—¶è¯¥å€¼æ‰ä¼šå˜ä¸ºæœ€æ–°å€¼ï¼‰ã€‚`useDeferredValue` å’Œ `startTransition` ä¸€æ ·éƒ½æ˜¯æ ‡è®°äº†ä¸€æ¬¡éç´§æ€¥æ›´æ–°

::: tip `useDeferredValue` ä¸ `useTransition`

- ç›¸åŒï¼š`useDeferredValue` æœ¬è´¨ä¸Šå’Œå†…éƒ¨å®ç°ä¸ `useTransition` ä¸€æ ·ï¼Œéƒ½æ˜¯æ ‡è®°æˆäº†`å»¶è¿Ÿæ›´æ–°`ä»»åŠ¡ã€‚
- ä¸åŒï¼š`useTransition` æ˜¯æŠŠæ›´æ–°ä»»åŠ¡å˜æˆäº†å»¶è¿Ÿæ›´æ–°ä»»åŠ¡ï¼Œè€Œ `useDeferredValue` æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„å€¼ï¼Œè¿™ä¸ªå€¼ä½œä¸ºå»¶æ—¶çŠ¶æ€ã€‚ï¼ˆä¸€ä¸ªç”¨æ¥åŒ…è£…æ–¹æ³•ï¼Œä¸€ä¸ªç”¨æ¥åŒ…è£…å€¼ï¼‰

:::

> ä½¿ç”¨ `useDeferredValue` æ”¹å†™ä¸Šé¢çš„ ğŸŒ°

```tsx
import React, { useState, useEffect, useDeferredValue } from 'react'

const App: React.FC = () => {
  const [list, setList] = useState<any[]>([])
  useEffect(() => {
    setList(new Array(10000).fill(null))
  }, [])
  // ä½¿ç”¨äº†å¹¶å‘ç‰¹æ€§ï¼Œå¼€å¯å¹¶å‘æ›´æ–°
  const deferredList = useDeferredValue(list)
  return (
    <>
      {deferredList.map((_, i) => (
        <div key={i}>{i}</div>
      ))}
    </>
  )
}

export default App
```

> æ‰§è¡Œå †æ ˆå›¾

![æ‰§è¡Œå †æ ˆå›¾](./images/react-18/execute-stack-concurrent.png)

ä»æ‰§è¡Œå †æ ˆå›¾çœ‹åˆ°ï¼Œä»»åŠ¡è¢«æ‹†åˆ†åˆ°æ¯ä¸€å¸§ä¸åŒçš„ `task` ä¸­ï¼Œ`JavaScript` æ‰§è¡Œæ—¶é—´å¤§ä½“åœ¨`5ms`å·¦å³ï¼Œè¿™æ ·æµè§ˆå™¨å°±æœ‰å‰©ä½™æ—¶é—´æ‰§è¡Œ**æ ·å¼å¸ƒå±€**å’Œ**æ ·å¼ç»˜åˆ¶**ï¼Œå‡å°‘æ‰å¸§çš„å¯èƒ½æ€§

å…³äº useDeferredValue çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [New in 18: useDeferredValue](https://github.com/reactwg/react-18/discussions/129)

#### æ™®é€šæƒ…å†µ

> å…³é—­å¹¶å‘ç‰¹æ€§åœ¨æ™®é€šæƒ…å†µä¸­è¿è¡Œé¡¹ç›®

```tsx
import React, { useState, useEffect } from 'react'

const App: React.FC = () => {
  const [list, setList] = useState<any[]>([])
  useEffect(() => {
    setList(new Array(10000).fill(null))
  }, [])
  return (
    <>
      {list.map((_, i) => (
        <div key={i}>{i}</div>
      ))}
    </>
  )
}

export default App
```

![æ‰§è¡Œå †æ ˆå›¾](./images/react-18/execute-stack.png)

ä»æ‰§è¡Œå †æ ˆå›¾çœ‹åˆ°ï¼Œç”±äºç»„ä»¶æ•°é‡ç¹å¤šï¼ˆ10000 ä¸ªï¼‰ï¼Œ`JavaScript` æ‰§è¡Œæ—¶é—´ä¸º `300ms`ï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€åœ¨æ²¡æœ‰å¹¶å‘ç‰¹æ€§çš„æƒ…å†µä¸‹ï¼šä¸€æ¬¡æ€§æ¸²æŸ“ `10000` ä¸ªæ ‡ç­¾çš„æ—¶å€™ï¼Œé¡µé¢ä¼šé˜»å¡å¤§çº¦ `0.3` ç§’ï¼Œé€ æˆå¡é¡¿ï¼›ä½†æ˜¯å¦‚æœå¼€å¯å¹¶å‘æ›´æ–°å°±ä¸ä¼šå­˜åœ¨è¿™æ ·çš„é—®é¢˜

::: tip å¹¶å‘æ¨¡å¼æ€»ç»“

- å¹¶å‘æ›´æ–°çš„æ„ä¹‰å°±æ˜¯`äº¤æ›¿æ‰§è¡Œ`ä¸åŒçš„ä»»åŠ¡ï¼Œå½“é¢„ç•™çš„æ—¶é—´ä¸å¤Ÿç”¨æ—¶ï¼Œ`React` å°†çº¿ç¨‹æ§åˆ¶æƒäº¤è¿˜ç»™æµè§ˆå™¨ï¼Œç­‰å¾…ä¸‹ä¸€å¸§æ—¶é—´åˆ°æ¥ï¼Œç„¶åç»§ç»­è¢«ä¸­æ–­çš„å·¥ä½œ
- `å¹¶å‘æ¨¡å¼`æ˜¯å®ç°`å¹¶å‘æ›´æ–°`çš„åŸºæœ¬å‰æ
- `æ—¶é—´åˆ‡ç‰‡`æ˜¯å®ç°`å¹¶å‘æ›´æ–°`çš„å…·ä½“æ‰‹æ®µ

:::

::: tip `fiber` çš„å«ä¹‰

1. `æ¶æ„`è§’åº¦ï¼šåœ¨æ—§çš„æ¶æ„ä¸­ï¼Œ`Reconcilerï¼ˆåè°ƒå™¨ï¼‰`é‡‡ç”¨é€’å½’çš„æ–¹å¼æ‰§è¡Œï¼Œæ— æ³•ä¸­æ–­ï¼ŒèŠ‚ç‚¹æ•°æ®ä¿å­˜åœ¨é€’å½’çš„è°ƒç”¨æ ˆä¸­ï¼Œè¢«ç§°ä¸º `Stack Reconciler`ï¼Œstack å°±æ˜¯è°ƒç”¨æ ˆï¼›åœ¨æ–°çš„æ¶æ„ä¸­ï¼Œ`Reconcilerï¼ˆåè°ƒå™¨ï¼‰`æ˜¯åŸºäº `fiber` å®ç°çš„ï¼ŒèŠ‚ç‚¹æ•°æ®ä¿å­˜åœ¨ `fiber` ä¸­ï¼Œæ‰€ä»¥è¢«ç§°ä¸º `fiber Reconciler`
2. é™æ€`æ•°æ®ç»“æ„`è§’åº¦ï¼šæ¯ä¸ª `fiber` å¯¹åº”ä¸€ä¸ªç»„ä»¶ï¼Œä¿å­˜äº†è¿™ä¸ªç»„ä»¶ç±»å‹å¯¹åº”çš„ `dom` èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿™æ—¶ï¼Œ`fiber` èŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„`è™šæ‹ŸDOM`
3. åŠ¨æ€`å·¥ä½œå•å…ƒ`è§’åº¦ï¼š`fiber` èŠ‚ç‚¹ä¿å­˜äº†è¯¥èŠ‚ç‚¹éœ€è¦æ›´æ–°çš„çŠ¶æ€ä»¥åŠéœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨

:::

---

::: info ç›¸å…³èµ„æ–™

[React18 æ–°ç‰¹æ€§è§£è¯» & å®Œæ•´ç‰ˆå‡çº§æŒ‡å—](https://github.com/li-jia-nan/How-to-Upgrade-to-React18)

:::
